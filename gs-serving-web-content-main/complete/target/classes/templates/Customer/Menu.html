<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thá»±c ÄÆ¡n - TTD Restaurant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .card:hover {
      transform: translateY(-4px) scale(1.02);
    }
    .card {
      transition: all 0.3s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- NAVIGATION -->
<nav class="bg-white border-b shadow-sm sticky top-0 z-30">
  <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
    <div class="text-xl font-bold text-red-600">TTD Restaurant</div>
    <ul class="flex space-x-6 font-semibold text-sm text-gray-700">
      <li><a href="#monchinh" class="hover:text-red-500">MÃ“N CHÃNH</a></li>
      <li><a href="#khaivi" class="hover:text-red-500">KHAI Vá»Š</a></li>
      <li><a href="#trangmieng" class="hover:text-red-500">TRÃNG MIá»†NG</a></li>
      <li><a href="#douong" class="hover:text-red-500">Äá»’ Uá»NG</a></li>
      <li>
        <a href="#" onclick="openTableModal()" class="hover:text-red-500 flex items-center space-x-1 relative">
          <span>ğŸ“‹</span>
          <span>BÃ n</span>
          <sup id="tableCheckBadge" class="absolute -top-2 -right-4 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden">âœ”</sup>
        </a>
      </li>
      
       <li>
        <a href="/cart" class="hover:text-red-500 flex items-center space-x-1 relative">
          <span>ğŸ›’</span>
          <span>Giá» hÃ ng</span>
          <sup id="cartCountBadge" class="absolute -top-2 -right-4 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden">0</sup>
        </a>
      </li>
      </ul>
  </div>
</nav>

<!-- DANH Má»¤C TEMPLATE (Ãp dá»¥ng cho táº¥t cáº£ danh má»¥c) -->
<section id="monchinh" class="max-w-6xl mx-auto py-10 px-4">
  <h2 class="text-2xl font-bold mb-2 text-red-600">MÃ“N CHÃNH</h2>
  <div class="grid md:grid-cols-2 gap-6 mt-6">
    <div th:each="mon : ${monChinh}"
         class="card bg-white rounded-2xl shadow-lg p-4 flex justify-between items-center cursor-pointer"
         th:attr="data-title=${mon.tenMonAn},
                  data-img='/images/' + ${mon.hinhAnh},
                  data-price=${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'"
         onclick="handleCardClick(this)">
      <div>
        <h3 class="text-lg font-bold text-gray-900" th:text="${mon.tenMonAn}">TÃªn mÃ³n</h3>
        <p class="text-sm text-gray-500 italic">HÆ°Æ¡ng vá»‹ Ä‘á»™c Ä‘Ã¡o, khÃ³ quÃªn</p>
        <p class="text-base font-semibold mt-2 text-red-500"
           th:text="${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'">GiÃ¡</p>
      </div>
      <img th:src="@{/images/{img}(img=${mon.hinhAnh})}" alt="HÃ¬nh mÃ³n Äƒn"
           class="w-28 h-20 rounded-lg object-cover shadow" />
    </div>
  </div>
</section>

<section id="khaivi" class="max-w-6xl mx-auto py-10 px-4">
  <h2 class="text-2xl font-bold mb-2 text-red-600">KHAI Vá»Š</h2>
  <div class="grid md:grid-cols-2 gap-6 mt-6">
    <div th:each="mon : ${khaiVi}"
         class="card bg-white rounded-2xl shadow-lg p-4 flex justify-between items-center cursor-pointer"
         th:attr="data-title=${mon.tenMonAn},
                  data-img='/images/' + ${mon.hinhAnh},
                  data-price=${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'"
         onclick="handleCardClick(this)">
      <div>
        <h3 class="text-lg font-bold text-gray-900" th:text="${mon.tenMonAn}">TÃªn mÃ³n</h3>
        <p class="text-sm text-gray-500 italic">MÃ³n khai vá»‹ tuyá»‡t háº£o</p>
        <p class="text-base font-semibold mt-2 text-red-500"
           th:text="${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'"></p>
      </div>
      <img th:src="@{/images/{img}(img=${mon.hinhAnh})}" alt="HÃ¬nh mÃ³n Äƒn"
           class="w-28 h-20 rounded-lg object-cover shadow" />
    </div>
  </div>
</section>

<section id="trangmieng" class="max-w-6xl mx-auto py-10 px-4">
  <h2 class="text-2xl font-bold mb-2 text-red-600">TRÃNG MIá»†NG</h2>
  <div class="grid md:grid-cols-2 gap-6 mt-6">
    <div th:each="mon : ${trangMieng}"
         class="card bg-white rounded-2xl shadow-lg p-4 flex justify-between items-center cursor-pointer"
         th:attr="data-title=${mon.tenMonAn},
                  data-img='/images/' + ${mon.hinhAnh},
                  data-price=${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'"
         onclick="handleCardClick(this)">
      <div>
        <h3 class="text-lg font-bold text-gray-900" th:text="${mon.tenMonAn}">TÃªn mÃ³n</h3>
        <p class="text-sm text-gray-500 italic">Ngá»t ngÃ o káº¿t thÃºc bá»¯a Äƒn</p>
        <p class="text-base font-semibold mt-2 text-red-500"
           th:text="${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'"></p>
      </div>
      <img th:src="@{/images/{img}(img=${mon.hinhAnh})}" alt="HÃ¬nh mÃ³n Äƒn"
           class="w-28 h-20 rounded-lg object-cover shadow" />
    </div>
  </div>
</section>

<section id="douong" class="max-w-6xl mx-auto py-10 px-4">
  <h2 class="text-2xl font-bold mb-2 text-red-600">Äá»’ Uá»NG</h2>
  <div class="grid md:grid-cols-2 gap-6 mt-6">
    <div th:each="mon : ${doUong}"
         class="card bg-white rounded-2xl shadow-lg p-4 flex justify-between items-center cursor-pointer"
         th:attr="data-title=${mon.tenMonAn},
                  data-img='/images/' + ${mon.hinhAnh},
                  data-price=${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'"
         onclick="handleCardClick(this)">
      <div>
        <h3 class="text-lg font-bold text-gray-900" th:text="${mon.tenMonAn}">TÃªn mÃ³n</h3>
        <p class="text-sm text-gray-500 italic">Giáº£i khÃ¡t sáº£ng khoÃ¡i</p>
        <p class="text-base font-semibold mt-2 text-red-500"
           th:text="${#numbers.formatDecimal(mon.donGia, 0, 'COMMA', 0, 'POINT')} + 'â‚«'"></p>
      </div>
      <img th:src="@{/images/{img}(img=${mon.hinhAnh})}" alt="HÃ¬nh mÃ³n Äƒn"
           class="w-28 h-20 rounded-lg object-cover shadow" />
    </div>
  </div>
</section>

<!-- MODAL DETAIL STYLE -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl overflow-hidden max-w-lg w-full animate-fade-in">
    <div class="relative">
      <img id="modalImage" src="" alt="HÃ¬nh mÃ³n Äƒn" class="w-full h-72 object-cover">
      <button onclick="closeModal()" class="absolute top-4 right-4 text-white text-xl font-bold">&times;</button>
    </div>
    <div class="px-6 py-4">
      <h2 id="modalTitle" class="text-xl font-bold text-gray-900 mb-1">TÃªn mÃ³n</h2>
      <p id="modalPrice" class="text-base text-red-500 font-semibold">GiÃ¡</p>
    </div>

    <!-- GIAO DIá»†N Äáº¸P HÆ N: Sá» LÆ¯á»¢NG VÃ€ GIá» HÃ€NG -->
    <div class="px-6 py-4 border-t flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 bg-white">
      <div class="flex items-center space-x-4">
        <button onclick="updateQuantity(-1)" class="w-10 h-10 flex items-center justify-center text-xl font-bold bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition">
          &minus;
        </button>
        <input id="quantityInput" type="number" value="1" min="1"
               class="w-14 text-center text-lg font-medium border border-gray-300 rounded-lg py-1 focus:outline-none focus:ring-2 focus:ring-red-400" />
        <button onclick="updateQuantity(1)" class="w-10 h-10 flex items-center justify-center text-xl font-bold bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition">
          +
        </button>
      </div>
      <button onclick="addToCart()" class="w-full sm:w-auto flex items-center justify-center space-x-2 bg-gradient-to-r from-orange-500 to-red-500 text-white font-semibold px-6 py-3 rounded-full hover:opacity-90 transition">
        <span>ğŸ›’ ThÃªm vÃ o giá»</span>
        <span id="modalTotal" class="font-bold">0â‚«</span>
      </button>
    </div>

    <div class="px-6 py-4 flex justify-end">
      <button onclick="closeModal()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">ÄÃ³ng</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
  const badge = document.getElementById("cartCountBadge");

  
  fetch('/cart/total')
    .then(res => res.json())
    .then(count => {
      if (count > 0) {
        badge.innerText = count;
        badge.classList.remove("hidden");
      }
    });
  
    // ğŸ‘‰ Xá»­ lÃ½ khi ngÆ°á»i dÃ¹ng click vÃ o mÃ³n Äƒn
    window.handleCardClick = function (element) {
      const title = element.dataset.title;
      const imageUrl = element.dataset.img;
      const price = element.dataset.price;
  
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalImage').src = imageUrl;
      document.getElementById('modalPrice').innerText = price;
      document.getElementById('quantityInput').value = 1;
  
      updateTotal();
      document.getElementById('imageModal').classList.remove('hidden');
    }
  
    // ğŸ‘‰ Cáº­p nháº­t sá»‘ lÆ°á»£ng khi nháº¥n + hoáº·c -
    window.updateQuantity = function (delta) {
      const input = document.getElementById("quantityInput");
      let current = parseInt(input.value) || 1;
      current = Math.max(1, current + delta);
      input.value = current;
      updateTotal();
    }
  
    // ğŸ‘‰ TÃ­nh tá»•ng tiá»n trong modal
    function updateTotal() {
      const quantity = parseInt(document.getElementById("quantityInput").value);
      const priceText = document.getElementById("modalPrice").innerText.replace(/[â‚«,]/g, '');
      const price = parseInt(priceText) || 0;
      const total = quantity * price;
      document.getElementById("modalTotal").innerText = total.toLocaleString('vi-VN') + 'â‚«';
    }
  
    window.addToCart = function () {
  const title = document.getElementById('modalTitle').innerText;
  const quantity = parseInt(document.getElementById("quantityInput").value);
  const priceText = document.getElementById("modalPrice").innerText.replace(/[â‚«,]/g, '');
  const price = parseInt(priceText) || 0;

  fetch('/cart/add', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      tenMonAn: title,
      soLuong: quantity,
      donGia: price
    })
  })
  .then(res => {
    if (res.ok) {
      return fetch('/cart/total'); // láº¥y láº¡i sá»‘ lÆ°á»£ng tá»« server
    } else {
      throw new Error("ThÃªm vÃ o giá» hÃ ng tháº¥t báº¡i");
    }
  })
  .then(res => res.json())
  .then(count => {
    if (badge) {
      badge.innerText = count;
      badge.classList.remove("hidden");
    }
    alert(`âœ… ÄÃ£ thÃªm ${quantity} x ${title} vÃ o giá» hÃ ng!`);
    closeModal();
  })
  .catch(err => {
    console.error('Lá»—i khi thÃªm vÃ o giá» hÃ ng:', err);
    alert("âŒ KhÃ´ng thá»ƒ thÃªm mÃ³n vÃ o giá» hÃ ng.");
  });
}

  
    // ğŸ‘‰ ÄÃ³ng modal
    window.closeModal = function () {
      document.getElementById('imageModal').classList.add('hidden');
    }
  });
  
  </script>
  <!-- MODAL CHá»ŒN BÃ€N -->
<div id="tableModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-lg">
    <h2 class="text-xl font-bold mb-4 text-gray-800">Chá»n bÃ n Äƒn</h2>
    <div id="tableList" class="grid grid-cols-2 gap-4">
      <!-- Danh sÃ¡ch bÃ n sáº½ Ä‘Æ°á»£c render báº±ng JS -->
    </div>
    <div class="mt-4 hidden" id="confirmTableArea">
      <p class="text-sm text-gray-600 mb-2">
        Äang chá»n: <span id="selectedTableName" class="font-semibold text-red-500"></span>
      </p>
      <button onclick="confirmTableSelection()"
              class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
        âœ… Äáº·t bÃ n
      </button>
    </div>
    <div class="mt-6 text-right">
      <button onclick="closeTableModal()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">ÄÃ³ng</button>
    </div>
  </div>
</div>
<script>
  let selectedMaBan = null;
  let selectedTenBan = null;

  // ğŸ‘‰ Má»Ÿ modal vÃ  load danh sÃ¡ch bÃ n
  window.openTableModal = function () {
    const modal = document.getElementById('tableModal');
    const listDiv = document.getElementById('tableList');
    document.getElementById("confirmTableArea").classList.add("hidden");
    listDiv.innerHTML = '<p class="text-gray-500 col-span-2">Äang táº£i danh sÃ¡ch bÃ n...</p>';

    fetch('/api/ban')
      .then(res => res.json())
      .then(data => {
        listDiv.innerHTML = '';
        data.forEach(ban => {
          const btn = document.createElement('button');
          btn.className = "bg-gray-100 border rounded-lg p-3 hover:bg-green-100 transition text-sm font-semibold text-gray-700";
          btn.innerText = `${ban.tenBan} (${ban.trangThai})`;
          btn.disabled = ban.trangThai !== "Trá»‘ng";
          btn.onclick = () => selectTable(ban.maBan, ban.tenBan);
          listDiv.appendChild(btn);
        });
      })
      .catch(err => {
        listDiv.innerHTML = '<p class="text-red-500 col-span-2">KhÃ´ng thá»ƒ táº£i danh sÃ¡ch bÃ n.</p>';
        console.error(err);
      });

    modal.classList.remove('hidden');
  };

  // ğŸ‘‰ ÄÃ³ng modal bÃ n
  window.closeTableModal = function () {
    document.getElementById('tableModal').classList.add('hidden');
  };

  // ğŸ‘‰ NgÆ°á»i dÃ¹ng click chá»n bÃ n
  window.selectTable = function (maBan, tenBan) {
    selectedMaBan = maBan;
    selectedTenBan = tenBan;
    document.getElementById("selectedTableName").innerText = tenBan;
    document.getElementById("confirmTableArea").classList.remove("hidden");
  };

  // ğŸ‘‰ XÃ¡c nháº­n â€œÄáº·t bÃ nâ€
  window.confirmTableSelection = function () {
    if (!selectedMaBan) return;

    fetch('/api/ban/datban', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ maBan: selectedMaBan })
    })
    .then(res => {
      if (res.ok) {
        sessionStorage.setItem("selectedTable", selectedTenBan);
        document.getElementById("tableCheckBadge").classList.remove("hidden");
        alert(`âœ… ÄÃ£ Ä‘áº·t ${selectedTenBan}`);
        closeTableModal();
        updateTableInfoInCart();
        updateCartBadge(); // ğŸ›’ cáº­p nháº­t sá»‘
      } else {
        alert("âŒ KhÃ´ng thá»ƒ Ä‘áº·t bÃ n.");
      }
    })
    .catch(err => {
      alert("âŒ CÃ³ lá»—i khi Ä‘áº·t bÃ n.");
      console.error(err);
    });
  };

  // ğŸ‘‰ Hiá»ƒn thá»‹ bÃ n Ä‘Ã£ Ä‘áº·t (vÃ­ dá»¥ trong giá» hÃ ng)
  function updateTableInfoInCart() {
    const table = sessionStorage.getItem("selectedTable");
    if (table) {
      let tableInfoDiv = document.getElementById("selectedTableInfo");
      if (!tableInfoDiv) {
        const cartSection = document.querySelector("#cartInfo") || document.body;
        tableInfoDiv = document.createElement("div");
        tableInfoDiv.id = "selectedTableInfo";
        tableInfoDiv.className = "text-sm text-green-600 font-semibold mt-2";
        cartSection.appendChild(tableInfoDiv);
      }
      tableInfoDiv.innerText = `ğŸª‘ BÃ n Ä‘Ã£ Ä‘áº·t: ${table}`;
    }
  }

  // ğŸ‘‰ Cáº­p nháº­t badge ğŸ›’: tá»•ng sá»‘ mÃ³n + bÃ n
  function updateCartBadge() {
    const badge = document.getElementById("cartCountBadge");
    let count = 0;

    fetch('/cart/total')
      .then(res => res.json())
      .then(serverCount => {
        count += serverCount || 0;

        if (sessionStorage.getItem("selectedTable")) {
          count += 1;
        }

        if (count > 0) {
          badge.innerText = count;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      })
      .catch(err => {
        console.error("Lá»—i khi cáº­p nháº­t badge giá» hÃ ng:", err);
      });
  }

  // ğŸ‘‰ Khi má»Ÿ láº¡i trang
  document.addEventListener("DOMContentLoaded", function () {
    updateTableInfoInCart();
    updateCartBadge();
  });
</script>




  